@using myRaiHelper;
@{
    ViewBag.Title = "HRIS - Assunzione";
    Layout = "~/Views/Shared/_LayoutContent.cshtml";
}

<style>
    .bigdrop {
        width: 100%;
    }
</style>


<section role="main" class="content-body">
    <main id="main-container">
        <div class="content">
            @using (Html.BeginOnePageNav("add-dip", "Assunzione"))
            {

                <div class="row">
                    <div class="col-sm-8">
                        @using (Html.BeginPanel(PanelType.PanelNoPadding, "Ultime assunzioni", true))
                        {
                            <div id="div_elencoimm"></div>
                        }
                    </div>
                    <div class="col-sm-4">
                        @using (Html.BeginPanel(PanelType.Panel, "Nuova assunzione", true, null, null, null, "sez_nuovaimm"))
                        {
                            <div id="nuovaimmatricolazioneByCF" class="row  push-10">
                                <div class="col-sm-12 form-group">
                                    <label class="rai-caption">CODICE FISCALE</label>
                                    <div class="input-group hidden-addon transparent-addon" id="cfGroupAddon">
                                        <input class="form-control form-control-value" style="width: 100%" onmouseup="disabledbuttonNuovaimmatricolazione()" onkeyup="checkDigit16chars()" id="checkCodiceFiscale" placeholder="Codice Fiscale" />
                                        <span class="input-group-addon">
                                            <i class="fa fa-warning feedback-warning-color" id="warningIcon"></i>
                                        </span>
                                    </div>
                                </div>



                            </div>
                            <div class="row push-10">
                                <div class="col-sm-12">
                                    <span style="display:none; color:red" id="msg_codicefiscaleerrore" class="error">Codice fiscale errato.</span>

                                </div>
                            </div>
                            <div class="row push-10">
                                <div class="col-sm-12">
                                    <span style="display:none; color:#EE9600;" id="msg_codicefiscaleesistente" class="bg-danger-light ">Esiste già un dipendente con questo codice fiscale. Consulta la scheda prima di procedere.</span>

                                </div>
                            </div>

                            <div class="row push-10">
                                <div class="col-sm-12">
                                    <div class="rai-btn-fill">
                                        <input type="button" style="display:none" id="btnShowDipendente" class="btn btn-sm rai-btn-small" title="Cerca" value="Visualizza dipendente" />
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-sm-12">
                                    <div class="rai-btn-fill">
                                        <input type="button" id="btnCercaCodiceFiscale" class="btn rai-btn-primary" title="Cerca" value="Nuova assunzione" onclick="checkCodiceFiscaleExistOrNot();" />
                                    </div>
                                </div>
                            </div>

                        }

                        <div id="sez_Ricerca">
                            <section class="rai panel" id="panelRicercaFoglioSpese">
                                <header class="panel-heading">
                                    <h2 class="panel-title">Cerca dipendente</h2>
                                </header>
                                <div class="panel-body">
                                    <form id="cercaImm">
                                        <div class="rai form-group">
                                            <div class="row">
                                                <div class="col-sm-12 push-10">
                                                    <label class="rai-caption">Periodo</label>
                                                    <div class="input-group">
                                                        <span class="input-group-addon" onclick="$('#rangeAssegnazione').click()"><i class="fa fa-calendar"></i></span>
                                                        <input type="text" class="form-control js-daterangepicker" id="rangeAssegnazione" value="" data-range="true" autocomplete="off" />
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row" style="display:none;">
                                                <div class="col-sm-6">
                                                    <label class="rai-caption">Dal</label>
                                                    <div class="input-group mb-md">
                                                        <span onclick="$('#datadal').datetimepicker('show')" class="input-group-addon"><i class="icons icon-calendar"></i></span>
                                                        <input class="js-datetimepicker form-control" data-format="DD/MM/YYYY" data-locale="it" type="text" id="datadal" name="datadal" placeholder="Periodo Dal">
                                                    </div>
                                                </div>
                                                <div class="col-sm-6">
                                                    <label class="rai-caption">Al</label>
                                                    <div class="input-group mb-md">
                                                        <span onclick="$('#dataal').datetimepicker('show')" class="input-group-addon"><i class="icons icon-calendar"></i></span>
                                                        <input class="js-datetimepicker form-control" data-format="DD/MM/YYYY" data-locale="it" type="text" id="dataal" name="dataal" placeholder="Periodo Al">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <label class="rai-caption">MATRICOLA</label>
                                                    <input type="text" class="form-control form-control-value mb-md" id="matricola" name="matricola" placeholder="Matricola" />
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <label class="rai-caption">NOMINATIVO</label>
                                                    <input type="text" class="form-control form-control-value mb-md" id="nome" name="nome" placeholder="Nome" />
                                                </div>
                                            </div>
                                            @*
                                                <div class="row">
                                                    <div class="col-sm-12">
                                                        <label class="rai-caption">COGNOME</label>
                                                        <input type="text" class="form-control form-control-value mb-md" id="cognome" name="codFiscale" placeholder="Cognome" />
                                                    </div>
                                                </div>
                                            *@
                                            <div class="row push-20-t">
                                                <div class="col-sm-12">
                                                    <div class="rai-btn-fill">
                                                        <input type="button" id="btnRipristina" class="btn rai-btn-secondary" title="Ripristina" value="Ripristina" onclick="RipristinaRicerca();" />
                                                        <input type="button" id="btnCercaMatricola" class="btn rai-btn-primary" title="Cerca" value="Cerca" onclick="LoadAssunzioniFilter();" />
                                                    </div>
                                                </div>

                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
            }
        </div>
    </main>

    <!-- end: page -->
</section>

@Html.RenderModal("dettaglio-imm", ModalPosition.Right, ModalSize.Full)


@section afterjs{
    <script type="text/javascript">
        var timer;
        InitDateRangePicker();
        $('#rangeAssegnazione').on({
            'apply.daterangepicker': function (event, daterange) {
                $('#datadal').val(daterange.startDate.format("DD/MM/YYYY"));
                $('#dataal').val(daterange.endDate.format("DD/MM/YYYY"));
            }
        })
        $('#rangeAssegnazione').val('');


    $(function () {
        $('#btnCercaCodiceFiscale').prop('disabled', true);
        prepareTableListaImmatrizolazioni();
        $("input").prop('required', true);

    });


        function RipristinaRicerca() {
            $('#cercaImm').trigger('reset'); //.clearFields();
        prepareTableListaImmatrizolazioni();
    }
    function disabledbuttonNuovaimmatricolazione() {

        //$('#warningIcon').hide();
        $('#cfGroupAddon').addClass('hidden-addon');
        $('#msg_codicefiscaleerrore').hide();
        $('#cfGroupAddon input, #cfGroupAddon .input-group-addon').css("border-color", "");
        var lengthCharcters = document.getElementById('checkCodiceFiscale').value.length;
        if (lengthCharcters == 0 || lengthCharcters < 16) {
            $('#btnCercaCodiceFiscale').prop('disabled', true);
        }
    }
    function mostraDettaglioImmatricolazione(id, idPersona) {
        RaiOpenAsyncModal('modal-dettaglio-imm', '@Url.Action("GetDettaglioAssunzione", "Assunzione")', { id: id }, function () {
            showWidgetProfile(idPersona);
        });
    }

    function showWidgetProfile(id) {

        $('#profile-widget').addClass('rai-loader');
        var boolShowButton = false;
        $.ajax({
            dataType: 'html',
            type: "GET",
            url: '@Url.Action("Widget_DatiDipendente", "Anagrafica")',
            data: { idPersona: id, isNeoMatr: true, actionToAnagrafica: boolShowButton, showCV: false, showInc: false, fromAssunzioni: true },
            success: function (result) {
                $('#profile-widget').html(result);
            },
            error: function (a, b, c) {
                swal({
                    title: "Ops...",
                    text: "Si è verificato un errore imprevisto\n" + c,
                    type: 'error'
                });
            },
            complete: function () {
                $('#profile-widget').removeClass('rai-loader');
            }
        });
    }
    function checkDigit16chars() {
        if ($("#btnShowDipendente").is(":visible")) {
            $("#btnShowDipendente").hide();
            document.getElementById("checkCodiceFiscale").style = "border:  1px solid #c2cfd6";
            $('#warning').hide();
            $('#msg_codicefiscaleesistente').hide();
            $('#msg_codicefiscaleerrore').hide();

        }

        var i = 0;
        var lengthCharcters = document.getElementById('checkCodiceFiscale').value.length;
        if (lengthCharcters < 16) {
            $('#btnCercaCodiceFiscale').prop('disabled', true);
        } else {
            $('#btnCercaCodiceFiscale').prop('disabled', false);
        }

    }
    //    function convert(str) {
    //
    //        var date = new Date(str);
    //    month = ("0" + (date.getMonth() + 1)).slice(-2),
    //    day = ("0" + date.getDate()).slice(-2);
    //    return [date.getFullYear(), month, day].join("-");
    //}
    function checkCodiceFiscaleExistOrNot() {
        var cf = $('#checkCodiceFiscale').val();
            $.ajax({
                url: '@Url.Action("CheckCodiceFiscaleExistOrNot","Assunzione")',
                dataType: 'json',
                type: "POST",
                data: { cf: cf },
                success: function (response) {
                    if (response.Data.Esito == false) {
                       if (response.Data.Exist == true) {
                            $('#btnShowDipendente').show();
                            //$('#warningIcon').show();
                            $('#cfGroupAddon').removeClass('hidden-addon');
                            //$('#checkCodiceFiscale').addClass("glyphicon-triangle-right");
                            $('#cfGroupAddon input, #cfGroupAddon .input-group-addon').css("border-color", "#EE9600");
                            $('#warning').show();
                            $('#btnCercaCodiceFiscale').prop('disabled', true);
                            $('#msg_codicefiscaleesistente').show();

                          //  $('#btnShowDipendente').click(visualizzaDipendente(response.Data.Data));

                            $('#btnShowDipendente').attr('onClick', 'visualizzaDipendente('+response.Data.Data+')');
                        }
                        else {
                            $('#cfGroupAddon').removeClass('hidden-addon');
                            $('#cfGroupAddon input, #cfGroupAddon .input-group-addon').css("border-color", "#ff0000");
                            $("#warningIcon").addClass("hidden");
                            $('#btnCercaCodiceFiscale').prop('disabled', true);
                            $('#msg_codicefiscaleerrore').show();


                        }
                    }
                    else {
                        var codicefiscale = response.Data.CodiceFiscale;
                        var exist = response.Data.Exist;
                        Assunzione_CheckTabAnagrafica();
                        Assunzione_CheckTabDatiContrattuali();
                        ///*Assunzione_CheckTabAllegati*/();
                        RaiOPNavGoToNext("add-dip", "nuovaimm", "Nuova Assunzione", "/Assunzione/ModaleInsertAndEditAssunzione", {  codicefiscale: codicefiscale ,exist: exist/*, letteraDicontrollo : letteraDicontrollo */});
                    }

                },
                error: function (a, b, c) { }

            });

        }
        function visualizzaDipendente(idpersona) {
           var url = '@(Url.Action("Index", "Anagrafica"))?idPersona=' + idpersona;
            window.location = url;
    return;



}
        function prepareTableListaImmatrizolazioni() {
            var tabs = $('#ulTabRicerca > li');
            var activeTab = $('#ulTabRicerca > li.active');
            var index = $(tabs).index(activeTab);
        $.ajax({
                url: '@Url.Action("InitAssunzioni", "Assunzione")',
                type: "GET",
                data: {},
                success: function (response) {
                    $('#div_elencoimm').html(response);
                    },
                error: function (e) {
                        console.log(e);
                    },
            complete: function () {
                if (index == 0 || index < 0) {
                    LoadTabInLavorazione();
                }
                if (index == 1) {
                    LoadTabDaLavorare();
                }
                        // LoadTabInAttesa();

                    }
                });
            }

            function LoadTabDaLavorare() {
                LoadAssunzioni("N");
            }
            function LoadTabInLavorazione() {
                LoadAssunzioni("L");
            }
            //function LoadTabFirmate() {
            //    LoadAssunzioni(1);
            //}
            //function LoadTabBozze() {
            //    LoadAssunzioni(3);
            //}
        function LoadAssunzioniFilter() {

            $('tbody').html(" ");
            var tabs = $('#ulTabRicerca > li');
            var activeTab = $('#ulTabRicerca > li.active');
            var index = $(tabs).index(activeTab);
            var stato = "L";
            if (index == 0) {
                $('#table_InLavorazione').addClass('rai-loader');
            }
            if (index == 1) {
                $('#table_DaLavorare').addClass('rai-loader');
                stato = "N";
            }


            $.ajax({
                url:'@Url.Action("LoadRicercaAssunzione", "Assunzione")',
                type: 'POST',
                data: { stato : stato, dal: $('#datadal').val(), al: $('#dataal').val(), matricola: $('#matricola').val(), nominativo: $('#nome').val()@* , cognome: $('#cognome').val()*@ },
                success: function (data) {
                    if (index == 0) {
                        $('#table_InLavorazione').removeClass('rai-loader');
                        $('#table_InLavorazione tbody').remove();
                        $('#table_InLavorazione').append(data);
                    } else {
                        $('#table_DaLavorare').removeClass('rai-loader');
                        $('#table_DaLavorare tbody').remove();
                        $('#table_DaLavorare').append(data);
                    }

                },
                error: function (e) {
                },
            });
        }
        //Assunzione_CheckTabAnagrafica();
        //Assunzione_CheckTabDatiContrattuali();
        ///*Assunzione_CheckTabAllegati*/();
        function apriAssunzione(id, idPersona, avanzamento) {
            if (avanzamento != null && avanzamento >= 80) {
                mostraDettaglioImmatricolazione(id, idPersona);
            } else {

                RaiOPNavGoToNext("add-dip", "add-imm", "Assunzione", '@Url.Action("ModaleInsertAndEditAssunzione", "Assunzione")', { id: id });
                //if (avanzamento != null && avanzamento == 60) {
                //    GetDataPerRiepilogo(id, 0);
                //}
            }

        }



    function GotoPreviousTab() {
        event.preventDefault();
        $('#btnProsegui').show();
        var steps = $('.wizard-steps > li');
        var activeTab = $('.wizard-steps > li.active');
        var stepCount = $(steps).length;
        var stepIndex = $(steps).index(activeTab);
        if (stepIndex == 0) {
            //$('#btnPrevTab').prop('disabled',true);
            $('#TabAttivo').val('1');
        } else if (stepIndex == 1) {
            $('#btnProsegui_').hide();
            $('#btnPrevTab').prop('disabled', true);
            $('#btnSave').hide();
            $('#btnProsegui').show();
            $('#TabAttivo').val('2');
        } else if (stepIndex == 2) {
            $('#btnSave').hide();
            $('#btnProsegui').hide();
            $('#btnProsegui_2').hide();
            $('#btnProsegui_').show();
            $('#TabAttivo').val('3');
        }
        else if (stepIndex == 3) {
            $('#btnSave').hide();
            $('#btnProsegui').hide();
            $('#btnProsegui_').hide();
            $('#btnProsegui_2').show();
            $('#TabAttivo').val('4');
        }

        $(activeTab).removeClass("completed");
        $(steps).eq(stepIndex - 1).find('a').click();
        }
        function ConcludiPratica() {
    var idEvento = $('[name=IdEvento]').val();
            swal({
                title: 'Sei sicuro di voler finalizzare il contratto?',
                text: "",
                type: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sì',
                cancelButtonText: 'No'
            }).then(function () {
           $.ajax({
                     url: '@Url.Action("FinalizzaContratto", "Assunzione")',
                     type: "POST",
                     dataType: 'json',
                     data: {
                         idEvento: idEvento
                     },
               success: function (data) {
                   if (data.Esito) {
                       swal({ title: 'Contratto finalizzato!', type: 'success', confirmButtonClass: "btn-primary", confirmButtonText: 'Ok', customClass: 'rai' }).then(function () {

                           window.location.href = "/Assunzione/Index/";
                       });;

                   } else {
                       swal({ title: 'Si è verificato un errore durante il salvataggio', type: 'error', confirmButtonClass: "btn-primary", confirmButtonText: 'Ok', customClass: 'rai' });
                   }
                     },
                     error: function (e, ex, ec) {
                         swal({ title: 'Si è verificato un errore!', type: 'error', confirmButtonClass: "btn-primary", confirmButtonText: 'Ok', customClass: 'rai' });
                         //console.log(e, ex, ec);
                     },

                 });

        });
        }
        function CondividiContratto() {
            var idContratto = $('[name=idContratto]').val();
            swal({
                title: 'Sei sicuro di voler condividere il contratto?',
                text: "",
                type: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sì',
                cancelButtonText: 'No'
            }).then(function () {
           $.ajax({
                     url: '@Url.Action("CondividiContratto", "Assunzione")',
                     type: "POST",
                     dataType: 'json',
                     data: {
                         idContratto: idContratto
                     },
               success: function (data) {
                   if (data.Esito) {
                       //$('#divDettaglioAssunzione').addClass('rai-loader');
                       timer = setTimeout(function () { ShowAlert(); }, 5000);
                       //swal({ title: 'Contratto acquisito!', type: 'success', confirmButtonClass: "btn-primary", confirmButtonText: 'Ok', customClass: 'rai' }).then(function () {
                       //    //$('#divCellularePin').show();
                       //    //$('#divInviaAnnullaPin').show();
                       //});

                   } else {
                       swal({ title: 'Si è verificato un errore', type: 'error', confirmButtonClass: "btn-primary", confirmButtonText: 'Ok', customClass: 'rai' });
                   }
                     },
                     error: function (e, ex, ec) {
                         swal({ title: 'Si è verificato un errore!', type: 'error', confirmButtonClass: "btn-primary", confirmButtonText: 'Ok', customClass: 'rai' });
                         //console.log(e, ex, ec);
                     },

                 });

        });
        }
        function ShowAlert() {
            
            $.ajax({
                url: '@Url.Action("PollingContratto", "Assunzione")',
                type: "POST",
                dataType: 'json',
                data: {
                    idEvento: $('[name=IdEvento]').val()
                },
                success: function (data) {
                    
                    if (data.success) {
                        clearTimeout(timer);
                        $('#divDettaglioAssunzione').addClass('rai-loader');
                        document.getElementById("div-allegato-firmato-container").innerHTML = '<a href="@(Url.Action( "ScaricaPDF" , "Assunzione" ))?idAllegato=' + data.responseText + '" class="rai-font-md text-primary" id="span-allegato"><i class="fa fa-download"> </i> ' + data.nomeFile + '</a>';
                        mostraDettaglioImmatricolazione($('[name=IdEvento]').val(), $('[name=IdPersona]').val());
                        $('#divDettaglioAssunzione').removeClass('rai-loader');
                        swal({ title: 'Contratto acquisito!', type: 'success', confirmButtonClass: "btn-primary", confirmButtonText: 'Ok', customClass: 'rai' })
                    }
                    
                },
                error: function (e, ex, ec) {
                    clearTimeout(timer);
                    $('#divDettaglioAssunzione').removeClass('rai-loader');
                    swal("error", "C'è stato un errore ci scusiamo per il disagio", "errore");
                    console.log(e, ex, ec);
                },

            });

            timer = setTimeout(ShowAlert, 5000);
        }


    function GotoNextTab() {
        event.preventDefault();
        var tabAnagrafica = true;
        $('#TabAnagrafica').val(tabAnagrafica);
        var cognome = $('#Cognome').val();
        var nome = $('#Nome').val();
        var datan = $('#DataNascita').val();
        var genere = $("input[name='Genere']:checked").val();
        var cf = $('#CodiceFiscale').val();
        var istat = $('#LuogoDiNascita').val();
        var idPersona = $('[name=IdPersona]').val();
        var idEvento = $('[name=IdEvento]').val();
        var steps = $('.wizard-steps > li');
        var activeTab = $('.wizard-steps > li.active');
        var stepCount = $(steps).length;
        var stepIndex = $(steps).index(activeTab);
        var nuovo = false;
        var tabAttivo = 1;
        if (idPersona == 0 || idPersona==null) nuovo = true;
                 $.ajax({
                     url: '@Url.Action("ControlloDatiAnagrafici", "Assunzione")',
                     type: "POST",
                     dataType: 'json',
                     data: {
                         nome: nome,
                         cognome: cognome,
                         dataNascita: datan,
                         genere: genere,
                         cf: cf,
                         comune: istat,
                         nuovo: nuovo,
                         idEvento: idEvento,
                         tabAttivo: tabAttivo
                     },
                     success: function (data) {
                         if (data.Esito == true) {
                             event.preventDefault();
                           if (stepIndex == stepCount - 2) {
                                 $('#btnProsegui').hide();
                             }
                             SaveDipendentePartial();
                             Assunzione_CheckTabDatiContrattuali();
                             $('#btnPrevTab').removeClass('disable');
                             $(activeTab).addClass("completed");
                             $(steps).eq(stepIndex + 1).find('a').click();
                             $('#btnProsegui').css("display", "none");
                             $('#btnProsegui_').css("display", "");
                             $('#btnProsegui_').show();
                             $('#btnPrevTab').prop('disabled', false);
                             var myInput = document.getElementById("Matricola");

                             if (myInput && myInput.value) {
                                 $('#wizfiltro-categoria').removeClass('rai-loader');
                             }
                             else {
                                 generaMatricola(nome, cognome);
                             }
                         } else {
                             $('#wizfiltro-categoria').removeClass('rai-loader');
                             document.getElementById("CodiceFiscale").style = "border:1px solid red";
                             var type = "error";
                             if (data.data.includes('omocodia')) {
                                 swal({
                                     title: 'incongruenza codice fiscale',
                                     text: "confermare che si tratta di omocodia",
                                     type: 'warning',
                                     showCancelButton: true,
                                     confirmButtonColor: '#3085d6',
                                     cancelButtonColor: '#d33',
                                     confirmButtonText: 'Sì',
                                     cancelButtonText: 'Annulla'
                                 }).then(function () {
                                     event.preventDefault();

                                     if (stepIndex == stepCount - 2) {
                                         $('#btnProsegui').hide();
                                     }
                                     $('#btnPrevTab').removeClass('disable');
                                     $(activeTab).addClass("completed");
                                     $(steps).eq(stepIndex + 1).find('a').click();
                                     $('#btnProsegui').css("display", "none");
                                     $('#btnProsegui_').css("display", "");
                                     $('#btnProsegui_').show();
                                     $('#btnPrevTab').prop('disabled', false);
                                     var myInput = document.getElementById("Matricola");

                                     if (myInput && myInput.value) {
                                         $('#wizfiltro-categoria').removeClass('rai-loader');
                                     }
                                     else {
                                         generaMatricola(nome, cognome);
                                     } })
                             }
                             else {
                                 swal({ title: "Errore", text: data.data, type: type });
                             }
                         }
                     },
                     error: function (e, ex, ec) {
                         swal("error", "C'è stato un errore ci scusiamo per il disagio", "errore");
                         console.log(e, ex, ec);
                     },

                 });

        }
        function GotoNextTab2() {
            $('#div_modalInserEditAssunzioni').addClass('rai-loader');

            var formData = $("form#add-imm");
            $('#TabAttivo').val("3");
            var matricolaCorrente = $("#MatricolaCorrente").val()
            $.ajax({
                url: '@Url.Action("GeneraContratto", "Assunzione")',
                type: "POST",
                dataType: 'json',
                data:$(formData).serialize(),
                success: function (data) {
                         if (data.Esito == true) {
                             event.preventDefault();
                             var tabAllegati = true;
                             $('#TabAllegati').val(tabAllegati);
                             SaveDipendentePartial();
                             var steps = $('.wizard-steps > li');
                             var activeTab = $('.wizard-steps > li.active');
                             var stepCount = $(steps).length;
                             var stepIndex = $(steps).index(activeTab);
                             $('#btnPrevTab').removeClass('disable');
                             $(activeTab).addClass("completed");
                             $(steps).eq(stepIndex + 1).find('a').click();
                             $('#btnProsegui').css("display", "none");
                             $('#btnProsegui_').css("display", "none");
                             $('#btnProsegui_2').css("display", "none");
                             $('#btnSave').css("display", "");

                             GetDataPerRiepilogo($('[name=IdEvento]').val(), data.data);
                             $('#div_modalInserEditAssunzioni').removeClass('rai-loader');
                         } else {
                             $('#div_modalInserEditAssunzioni').removeClass('rai-loader');
                             swal({ title: "Si è verificato un errore durante la generazione del contratto", type: 'error', confirmButtonClass: "btn-primary", confirmButtonText: 'Ok', customClass: 'rai' });
                         }
                     },
                     error: function (e, ex, ec) {
                         swal("error", "C'è stato un errore ci scusiamo per il disagio", "errore");
                         console.log(e, ex, ec);
                     },

                 });
        //    event.preventDefault();
        //    var tabAllegati = true;
        //    $('#TabAllegati').val(tabAllegati);
        //var nome = $('#Nome').val();
        //var cognome = $('#Cognome').val();
        //var istat = $('#LuogoDiNascita').val();
        //var provincia = $('#Provincia').val();
        //var comune = $('#LuogoDiNascita').text();
        //var dataNascita = $('#DataNascita').val();
        //var genere = $("input[name='Genere']:checked").val();
        //var cf = $('#CodiceFiscale').val();
        //var secondoCognome = $('#SecondoCognome').val();
        //var cittadinanza = $('#Cittadinanza').text();
        //var azienda = $('#SelectedAzienda option[selected]').text();
        //var dataInizio = $('#DataInizio').val();
        //var dataFine = $('#DataFine').val();
        //var sede = $('#SelectedSede').val();
        //var sedeDescrizione = $('#SelectedSede').text();
        //var categoria = $('#SelectedCategoria').text();
        //var servizio = $('#SelectedServizio').text();
        //var sezione = $('#SelectedSezione').text();
        //var mansione = $('#SelectedMansione').text();
        //    var rappLavoro = $('#SelectedFormaContratto').val();
        //var nota = $('#Note').val();
        //    var rapportoLavoroDescrizione = $('#SelectedTipoAssunzione option[selected]').text();
        //    var tipoContrattoDescrizione = $('#SelectedFormaContratto option[selected]').text();
        //    var matricola = $('#MatricolaCorrente').val();
        //    SaveDipendentePartial();
        //        var steps = $('.wizard-steps > li');
        //        var activeTab = $('.wizard-steps > li.active');
        //        var stepCount = $(steps).length;
        //        var stepIndex = $(steps).index(activeTab);
        //        $('#btnPrevTab').removeClass('disable');
        //        $(activeTab).addClass("completed");
        //        $(steps).eq(stepIndex + 1).find('a').click();
        //        $('#btnProsegui').css("display", "none");
        //        $('#btnProsegui_').css("display", "none");
        //        $('#btnProsegui_2').css("display", "none");
        //        $('#btnSave').css("display", "");

        //    GetDataPerRiepilogo($('[name=IdEvento]').val());
        }
        function GetDataPerRiepilogo(id, idContratto) {
            $.ajax({
                url: "/Assunzione/GetDataPerRiepilogo",
                type: "GET",
                async: false,
                data: {
                    id: id,
                    idContratto: idContratto
                },
                contentType: "application/json; charset=utf-8",
                dataType: 'html',
                success: function (data) {
                    //alert("ciao");
                    $('#wizriepilogo').html(data);
                },
                error: function (xhr, status) {
                    swal({
                        title: 'Si è verificato un errore nel reperimento dei dati',
                        type: 'error',
                        showConfirmButton: true,
                        confirmButtonText: 'Ok',
                        customClass: 'rai'
                    });
                }
            });
        }

        function generaMatricola(nome, cognome) {
        $.ajax({
            url: '@Url.Action("GeneraMatricola", "Immatricolazione")',
            type: "POST",
            dataType: 'json',
            data: {
                        nome: nome,
                        cognome: cognome,
                    },
            success: function (data) {
                        if (data.Esito == true) {
                            console.log(data.data);

                            $('#Matricola').attr('readonly', 'readonly');
                            $('#Matricola').val(data.data);
                            $('#wizfiltro-categoria').removeClass('rai-loader');

                        }
                        else {
                            swal("Errore", "Errore di calcolo ", "error")
                        }
                        console.log("ok");
                    },

            error: function (e, ex, ec) {
                        console.log(e, ex, ec);
                    }
        });
    }
        function GotoNextTab1() {
            event.preventDefault();
            var tabDatiContrattuali = true;
            $('#TabDatiContrattuali').val(tabDatiContrattuali);
            $('#TabAttivo').val("2");

            var formData = $("form#add-imm");
            $.ajax({
                url: '@Url.Action("ControlloDatiAnagraficiContratto", "Assunzione")',
                type: "POST",
                dataType: 'json',
                data:
                    $(formData).serialize(),
                success: function (data) {
                    SaveDipendentePartial();
                    var steps = $('.wizard-steps > li');
                    var activeTab = $('.wizard-steps > li.active');
                    var stepCount = $(steps).length;
                    var stepIndex = $(steps).index(activeTab);
                    $('#btnPrevTab').removeClass('disable');
                    $(activeTab).addClass("completed");
                    $(steps).eq(stepIndex + 1).find('a').click();
                    //if ($('#btnPrevTab').click(function () { $('#btnProsegui_').css("display", "none"); }));
                    $('#btnProsegui').css("display", "none");
                    $('#btnProsegui_').css("display", "none");
                    $('#btnProsegui_2').css("display", "");
                },
            });

    }
    function CalcolaCodiceFiscale() {
        event.preventDefault();
        var cognome = $('#Cognome').val();
        var nome = $('#Nome').val();
        var data = $('#DataNascita').val();
        var istat = $('#LuogoDiNascita').val();
        var genere = $("input[name='Genere']:checked").val();
        if ((nome == "") || (cognome == "") ||  (data == "") || (istat == null || istat == "") )
            return swal({ title: "Errore Validazione", text: "Controlla che  campi contrassegnati con * siano compilati!", type: "error" });
        $.ajax({
                url: '@Url.Action("CalcolaCF", "Assunzione")',
                type: "POST",
                dataType: 'json',
                data: {
                    id: $("input[name=IdEvento]").val(),
                    nome: nome,
                    cognome: cognome,
                    dataNascita: data,
                    genere: genere,
                    istat: istat
                },
                success: function (data) {
                    if (data.Esito == true) {
                        $("#CodiceFiscale").val(data.cf);
                    }
                    else {
                        swal("Errore", "Errore di calcolo ", "error")
                    }

                },
                error: function (e, ex, ec) {
                    console.log(e, ex, ec);
                }
            });
    }

        function SaveDipendente() {
            var completo = true;
            $('#Completo').val(completo);

        var formData = $("form#add-imm");
        swal({
                title: 'Sei sicuro di voler confermare?',
                text: "La pratica sarà inviata in Dematerializzazione.",
            type: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sì, conferma!',
                cancelButtonText: 'Annulla'
        }).then(function () {
            $('#div_modalInserEditAssunzioni').addClass('rai-loader');
           $.ajax({
            url: '@Url.Action("HandleAssunzioneFinal", "Assunzione")',
            type: "POST",
            dataType: 'json',
            data: $(formData).serialize(),
            success: function (data) {
                console.log($(formData));
                LoadAssunzioni("L");
                $('#div_modalInserEditAssunzioni').removeClass('rai-loader');
                switch (data.Esito) {
                    case "OK":
                        $('#checkCodiceFiscale').val("");
                        swal({ title: 'Pratica inserita correttamente', type: 'success', confirmButtonClass: "btn-primary", confirmButtonText: 'Visualizza', customClass: 'rai' }).then(function () {

                            RaiOPGotoMain("add-dip");
                            mostraDettaglioImmatricolazione(data.idEvento, data.idPersona)
                        });
                        break;
                            case "MODIFICA":
                        swal({ title: 'Pratica inserita correttamente', type: 'success', confirmButtonClass: "btn-primary", confirmButtonText: 'Visualizza', customClass: 'rai' }).then(function () {
                            RaiOPGotoMain("add-dip");
                            mostraDettaglioImmatricolazione(data.idEvento, data.idPersona)
                                                   });
                        break;
                    case "KO":
                        swal({ title: data.Data, type: 'warning', confirmButtonClass: "btn-primary", confirmButtonText: 'Ok', customClass: 'rai' });
                       break;
                            default:
                        swal({ title: "Ops...", text: "Errore imprevisto ci scusiamo per il disagio", type: 'error', confirmButtonClass: "btn-primary", confirmButtonText: 'Ok', customClass: 'rai' });
                                break;
                                $(formData).parent().removeClass("rai-loader");
                }
            },
            error: function (a, b, c) {
                swal({ title: "Ops...", text: ' ' + b + ' ' + c, type: 'error' });
                console.log(a, b, c);
                $(formData).parent().removeClass("rai-loader");
                $('#div_modalInserEditAssunzioni').removeClass('rai-loader');
                }
        });

            });
            //$('#div_modalInserEditAssunzioni').removeClass('rai-loader');
        }
        function SaveDipendentePartial() {
            //var completo = true;
            //$('#Completo').val(completo);
        var formData = $("form#add-imm");
           $.ajax({
            url: '@Url.Action("HandleAssunzione", "Assunzione")',
            type: "POST",
            dataType: 'json',
            data: $(formData).serialize(),
            success: function (data) {
            },
            error: function (a, b, c) {
                swal({ title: "Ops...", text: ' ' + b + ' ' + c, type: 'error', confirmButtonClass: "btn-primary", confirmButtonText: 'Ok', customClass: 'rai' });
                console.log(a, b, c);
                $(formData).parent().removeClass("rai-loader");
                }
        });
    }
        function LoadAssunzioni(stato) {
            var appos=stato;
        $.ajax({
            url: '@Url.Action("GetListaAssunzioni", "Assunzione")',
            type: "GET",
            data: {stato:stato},
            success: function (response) {
                $('tbody').html(" ");
                if (appos == "N") {
                    $('#table_DaLavorare').removeClass('rai-loader');
                    //$('#listaImmatricolazioniInAttesa').html(response);
                    $('#table_DaLavorare tbody').remove();
                    $('#table_DaLavorare').append(response);
                }
                else if (appos == "L") {
                    $('#table_InLavorazione').removeClass('rai-loader');
                    //$('#listaImmatricolazioniFirmate').html(response);
                    $('#table_InLavorazione tbody').remove();
                    $('#table_InLavorazione').append(response);
                }
            },
            error: function (e) {
                console.log(e);
            },

        });
    }
    function eliminaAssunzione(id) {
        swal({
                title: 'Sei sicuro?',
                text: "L'assunzione verrà cancellata",
            type: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sì, cancella!',
                cancelButtonText: 'Annulla'
            }).then(function () {
           $.ajax({
                    url: '@Url.Action("EliminaAssunzione", "Assunzione")',
                    dataType: 'html',
                    type: "GET",
                    data: { idEvento: id },
               success: function (data) {
                   LoadAssunzioni("L");
                        switch (data) {
                            case "OK":
                                swal('Cancellazione assunzione', "Assunzione cancellata con successo", "success");
                                break;
                            default:
                                swal("Oops...", data, 'error')
                        }
                    }
                });

        });
        }
        function Assunzione_CheckTabAnagrafica() {
            var pronto1 = false;
            var cognome = $('#Cognome').val();
            var nome = $('#Nome').val();
            var datan = $('#DataNascita').val();
            var genere = $("input[name='Genere']:checked").val();
            var istat = $('#LuogoDiNascita').val();
            var residenza = $('#LuogoDiNascita').val();
            var cittadinanza = $('#Cittadinanza').val();

            //alert(cognome);
            //alert(nome);
            //alert(datan);
            //alert(genere);
            //alert(istat);
            //alert(cittadinanza);



            if (cognome !== null && cognome !== "" && cognome !== "undefined" && cognome !== "-1"
                && nome !== null && nome !== "" && nome !== "undefined" && nome !== "-1"
                && datan !== null && datan !== "" && datan !== "undefined" && datan !== "-1"
                && genere !== null && genere !== "" && genere !== "undefined" && genere !== "-1"
                && istat !== null && istat !== "" && istat !== "undefined" && istat !== "-1"
                && residenza !== null && residenza !== "" && residenza !== "undefined" && residenza !== "-1"
                && cittadinanza !== null && cittadinanza !== "" && cittadinanza !== "undefined" && cittadinanza !== "-1") {
                pronto1 = true;
            }
            if (pronto1) {
                $('#btnProsegui').removeClass('disable');
            }
            else {
                if (!$('#btnProsegui').hasClass('disable')) {
                    $('#btnProsegui').addClass('disable');
                }
            }
        }
        function Assunzione_CheckTabDatiContrattuali() {
            var pronto1 = false;
            var azienda = $('#SelectedAzienda option[selected]').text();
            var dataInizio = $('#DataInizio').val();
            var dataFine = $('#DataFine').val();
            var sede = $('#SelectedSede').val();
            var categoria = $('#categoria').text();
            var servizio = $('#SelectedServizio').text();
            var sezione = $('#SelectedSezione').text();
            var mansione = $('#SelectedMansione').text();
            var rappLavoro = $('#SelectedTipoAssunzione').val();
            var formacontratto = $('#SelectedFormaContratto').val();
            var tipominimo = $('#tipoMinimo').val();
            //var indennita = $('#Indennita').val();
            var causaleassunzione = $('#SelectedCausaleAssunzione').val();
            var modalitareclutamento = $('#SelectedModalitaReclutamento').val();


            if (azienda !== "" && azienda !== null && azienda !== "undefined" && azienda !== "-1"
                && dataInizio !== "" && dataInizio !== null && dataInizio !== "undefined" && dataInizio !== "-1"
                //&& dataFine !== "" && dataFine !== null && dataFine !== "undefined" && dataFine !== "-1"
                && sede !== null && sede !== "" && sede !== "undefined" && sede !== "-1"
                && categoria !== "" && categoria !== null && categoria !== "undefined" && categoria !== "-1"
                && servizio !== "" && servizio !== null && servizio !== "undefined" && servizio !== "-1"
                && sezione !== "" && sezione !== null && sezione !== "undefined" && sezione !== "-1"
                && rappLavoro !== "" && rappLavoro !== null && rappLavoro !== "undefined" && rappLavoro !== "-1"
                && mansione !== "" && mansione !== null && mansione !== "undefined" && mansione !== "-1"
                && formacontratto !== "" && formacontratto !== null && formacontratto !== "undefined" && formacontratto !== "-1"
                && causaleassunzione !== "" && causaleassunzione !== null && causaleassunzione !== "undefined" && causaleassunzione !== "-1"
                && modalitareclutamento !== "" && modalitareclutamento !== null && modalitareclutamento !== "undefined" && modalitareclutamento !== "-1"
                && tipominimo !== "" && tipominimo !== null && tipominimo !== "undefined" && tipominimo !== "-1"
                /*&& indennita !== null && indennita !== "" && indennita !== "undefined" && indennita !== "-1"*/)
                 {
                pronto1 = true;
            }
            if (pronto1) {
                $('#btnProsegui_').removeClass('disable');
            }
            else {
                if (!$('#btnProsegui_').hasClass('disable')) {
                    $('#btnProsegui_').addClass('disable');
                }
            }
        }
        function Assunzione_CheckTabAllegati() {
            var pronto1 = true;

            if (pronto1) {
                $('#btnProsegui_2').removeClass('disable');
            }
            else {
                if (!$('#btnProsegui_2').hasClass('disable')) {
                    $('#btnProsegui_2').addClass('disable');
                }
            }
        }
        function FiltraTipoMinimo() {
            var categoria = $('#categoria').val();
            if (categoria !== null && categoria !== "" && categoria !== "-1") {
                categoria = $.trim(categoria);
                categoria = categoria.toUpperCase();
                RaiSelectExtLoadAsyncData('tipoMinimo', '/Assunzione/GetTipiMinimiPerCategoria', { codice: null, categoria: categoria });
            }




        }
        function changeTipoMinimo() {
            var tipominimo = $('#tipoMinimo').val();
            var categoria = $('#categoria').val();
            if (tipominimo !== "" && tipominimo !== null && tipominimo !== "undefined" && tipominimo !== "-1") {
                tipominimo = $.trim(tipominimo);
                tipominimo = tipominimo.toUpperCase();
                RaiSelectExtLoadAsyncData('orarioSelect', '/Assunzione/GetOrarioTipiMinimi', { codice: null, tipoMinimo: tipominimo, categoria: categoria }, null, ShowHideOrarioSelect);
                //$('#oreTipoMinimo').show();
                //ShowHideOrarioSelect();
            }
        }
        function changeSelectServizio() {

            $("#SelectedSezione").find("option").empty();
            $("#sezione").find("span").empty();
            getParametriSezioni();

        }
        function decodProvincia() {

        $.ajax({
                url: '@Url.Action("DecodProvincia", "Assunzione")',
                    type: "POST",
                    dataType: 'json',
                data: {
                    cod: $('#LuogoDiNascita').val()
                    },
                    success: function (data) {
                        if (data.Esito == true) {
                            $('#Provincia').val(data.codice);
                        }
                        else {
                            swal("Errore", "error")
                        }
                        console.log("ok");
                    },

                    error: function (e, ex, ec) {
                        console.log(e, ex, ec);
                    }

            });

        }
        function getParametriSezioni() {

            return {
                azienda: $('#SelectedAzienda').val(),
                servizio: $('#SelectedServizio').val()
            };
    }
    function Assunzione_CaricaContratto() {
        //var totalFiles = document.getElementById("#contrattoUpload").files.length;
        var formData = new FormData();

        //for (var i = 0; i < totalFiles; i++) {
        var file = document.getElementById("contrattoUpload").files[0];
        var nomefile = file.name;

        if (nomefile.toLowerCase().indexOf(".doc") < 0 &&
                nomefile.toLowerCase().indexOf(".docx") < 0)
            {
                swal("Formato file non supportato. Sono ammessi soltanto .doc e .docx");
                return;
            }

        //formData.append('filePrincipale', false);
        formData.append('file', file);
        //formData.append("nome", nomefile);
        //formData.append("tipo", 'PDF');
        formData.append("idEvento", $('[name=IdEvento]').val());
        //}

        var request = new XMLHttpRequest();
        request.onreadystatechange = function () {
            if (request.readyState === 4 && request.status === 200) {
                var data = $.parseJSON(request.responseText);
                if (data.success) {
                    GetDataPerRiepilogo($('[name=IdEvento]').val(), data.responseText);
                    $('#contrattoUpload').val('');
                    swal({ title: 'Contratto caricato correttamente!', type: 'success', confirmButtonClass: "btn-primary", confirmButtonText: 'Ok', customClass: 'rai' })
                }
                else {
                    Assunzione_Upload_OnFailure(data);
                }
            }
        };

        request.open('post', "/Assunzione/UploadFileContratto");
        request.timeout = 45000;
        request.send(formData);
        }
        function Assunzione_CaricaContrattoFirmato() {
            //var totalFiles = document.getElementById("#contrattoUpload").files.length;
            var formData = new FormData();
            $('#divDettaglioAssunzione').addClass('rai-loader');
            //for (var i = 0; i < totalFiles; i++) {
            var file = document.getElementById("contrattoFirmatoUpload").files[0];
            var nomefile = file.name;

            if (nomefile.toLowerCase().indexOf(".pdf") < 0) {
                swal("Formato file non supportato. Sono ammessi soltanto .pdf");
                $('#divDettaglioAssunzione').removeClass('rai-loader');
                return;
            }

            //formData.append('filePrincipale', false);
            formData.append('file', file);
            //formData.append("nome", nomefile);
            //formData.append("tipo", 'PDF');
            formData.append("idEvento", $('[name=IdEvento]').val());
            formData.append('firmato', true);
            //}

            var request = new XMLHttpRequest();
            request.onreadystatechange = function () {
                if (request.readyState === 4 && request.status === 200) {
                    var data = $.parseJSON(request.responseText);
                    if (data.success) {
                        //alert(data.responseText);
                        //alert(data.nomeFile);
                        //GetDataPerRiepilogo($('[name=IdEvento]').val(), data.responseText);
                        $('#contrattoFirmatoUpload').val('');
                        //document.getElementById("div-allegato-firmato-container").innerHTML = "CIAO";
                        document.getElementById("div-allegato-firmato-container").innerHTML = '<a href="@(Url.Action( "ScaricaPDF" , "Assunzione" ))?idAllegato=' + data.responseText + '" class="rai-font-md text-primary" id="span-allegato"><i class="fa fa-download"> </i> ' + data.nomeFile + '</a>';
                        mostraDettaglioImmatricolazione($('[name=IdEvento]').val(), $('[name=IdPersona]').val());
                        $('#divDettaglioAssunzione').removeClass('rai-loader');
                        //$('#divContratto').show();
                        swal({ title: 'Contratto caricato correttamente!', type: 'success', confirmButtonClass: "btn-primary", confirmButtonText: 'Ok', customClass: 'rai' });
                    }
                    else {
                        Assunzione_Upload_OnFailure(data);
                    }
                }
            };

            request.open('post', "/Assunzione/UploadFileContratto");
            request.timeout = 45000;
            request.send(formData);
        }
        function AssunzioneRipristinaContratto() {
            $('#div_modalInserEditAssunzioni').addClass('rai-loader');

            var formData = $("form#add-imm");
            $.ajax({
                url: '@Url.Action("GeneraContratto", "Assunzione")',
                type: "POST",
                dataType: 'json',
                data:$(formData).serialize(),
                success: function (data) {
                         if (data.Esito == true) {

                             GetDataPerRiepilogo($('[name=IdEvento]').val(), data.data);
                             $('#div_modalInserEditAssunzioni').removeClass('rai-loader');
                             swal({ title: 'Contratto ripristinato correttamente!', type: 'success', confirmButtonClass: "btn-primary", confirmButtonText: 'Ok', customClass: 'rai' })
                         } else {
                             $('#div_modalInserEditAssunzioni').removeClass('rai-loader');
                             swal({ title: "Si è verificato un errore durante il ripristino del contratto", type: 'error', confirmButtonClass: "btn-primary", confirmButtonText: 'Ok', customClass: 'rai' });
                         }
                     },
                     error: function (e, ex, ec) {
                         swal("error", "C'è stato un errore ci scusiamo per il disagio", "errore");
                         console.log(e, ex, ec);
                     },

                 });
        }

    </script>
}
