@using myRaiHelper
@using myRaiCommonModel.Gestionale
@model MboIniziativa

@{
    string title = "Nuova iniziativa";

    var rangeAssegnazione = "";
    var rangeValutazione = "";
    if (Model.Id != 0)
    {
        rangeAssegnazione = Model.DataInizioAssegnazione.ToString("dd/MM/yyyy") + " - " + Model.DataFineAssegnazione.ToString("dd/MM/yyyy");
        rangeValutazione = Model.DataInizioValutazione.ToString("dd/MM/yyyy") + " - " + Model.DataFineValutazione.ToString("dd/MM/yyyy");
    }
}

@using (Html.BeginModal(title))
{
    using (Html.BeginForm("Save_Iniziativa", "Mbo", FormMethod.Post, new { @id = "form-iniziativa" }))
    {
        @Html.HiddenFor(m => m.Id)

        //using (Html.BeginOnePageNav("bc-iniziativa", "Definizione iniziativa"))
        {
            using (Html.BeginPanel(PanelType.NoHeader, ""))
            {
                <div class="wizard-progress" id="ini-wizard" style="margin:5px;">
                    <ul class="wizard-steps">
                        <li class="tabhead disabled active">
                            <a href="#tab-generali"><span>1</span>Parametri iniziali</a>
                        </li>
                        @*<li class="tabhead disabled">
                                <a href="#tab-importi"><span>2</span>Definizione importi</a>
                            </li>*@
                        <li class="tabhead disabled">
                            <a href="#tab-schede"><span>2</span>Definizione schede</a>
                        </li>
                        <li class="tabhead disabled">
                            <a href="#tab-riepilogo"><span>3</span>Riepilogo</a>
                        </li>
                    </ul>
                    <div class="tab-content no-padding no-border no-shadow">
                        <div class="tab-pane active" id="tab-generali" role="tabpanel">
                            @using (Html.BeginBlock(BlockType.ContentTable, "Dati generali"))
                            {
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-sm-12 push-10">
                                            @Html.LabelForRequiredObbl(m => m.Nome, "Nome", new { @class = "rai-caption" })
                                            @Html.TextBoxFor(m => m.Nome, new { @class = "form-control", required = "required" })
                                            @Html.ValidationMessageFor(m => m.Nome)
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-12 push-10">
                                            @Html.LabelFor(m => m.Descrizione, new { @class = "rai-caption" })
                                            @Html.TextBoxFor(m => m.Descrizione, new { @class = "form-control" })
                                        </div>
                                    </div>
                                    <div class="row push-10">
                                        <div class="col-sm-6">
                                            @Html.LabelForRequiredObbl(m => m.DataInizioAssegnazione, "Periodo di assegnazione", new { @class = "rai-caption" })
                                            <div class="input-group">
                                                <span class="input-group-addon" onclick="$('#rangeAssegnazione').click()"><i class="fa fa-calendar"></i></span>
                                                <input type="text" class="form-control js-daterangepicker" id="rangeAssegnazione" value="@rangeAssegnazione" required="required" />
                                            </div>
                                        </div>
                                        <div class="col-sm-6">
                                            @Html.LabelForRequiredObbl(m => m.DataInizioValutazione, "Periodo di valutazione", new { @class = "rai-caption" })
                                            <div class="input-group">
                                                <span class="input-group-addon" onclick="$('#rangeValutazione').click()"><i class="fa fa-calendar"></i></span>
                                                <input type="text" class="form-control js-daterangepicker" id="rangeValutazione" value="@rangeValutazione" required="required" />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row push-10 hidden">
                                        <div class="col-sm-6 push-10">
                                            <div class="input-group">
                                                <span class="input-group-addon" onclick="$('#DataInizioAssegnazione').datetimepicker('show')"><i class="fa fa-calendar"></i></span>
                                                @Html.TextBoxFor(m => m.DataInizioAssegnazione, new { @class = "js-datetimepicker  form-control", data_format = "DD/MM/YYYY", data_locale = "it", placeholder = "Inizio assegnazione", autocomplete = "off", required = "required" })
                                            </div>
                                            @Html.ValidationMessageFor(m => m.DataInizioAssegnazione)
                                        </div>
                                        <div class="col-sm-6 push-10">
                                            <div class="input-group">
                                                <span class="input-group-addon" onclick="$('#DataFineAssegnazione').datetimepicker('show')"><i class="fa fa-calendar"></i></span>
                                                @Html.TextBoxFor(m => m.DataFineAssegnazione, new { @class = "js-datetimepicker  form-control", data_format = "DD/MM/YYYY", data_locale = "it", placeholder = "Inizio assegnazione", autocomplete = "off", required = "required" })
                                            </div>
                                            @Html.ValidationMessageFor(m => m.DataFineAssegnazione)
                                        </div>
                                    </div>
                                    <div class="row push-10 hidden">
                                        <div class="col-sm-12">
                                            @Html.LabelForRequiredObbl(m => m.DataInizioValutazione, "Periodo di valutazione", new { @class = "rai-caption" })
                                        </div>
                                        <div class="col-sm-6 push-10">
                                            <div class="input-group">
                                                <span class="input-group-addon" onclick="$('#DataInizioValutazione').datetimepicker('show')"><i class="fa fa-calendar"></i></span>
                                                @Html.TextBoxFor(m => m.DataInizioValutazione, new { @class = "js-datetimepicker  form-control", data_format = "DD/MM/YYYY", data_locale = "it", placeholder = "Inizio assegnazione", autocomplete = "off", required = "required" })
                                            </div>
                                            @Html.ValidationMessageFor(m => m.DataInizioValutazione)
                                        </div>
                                        <div class="col-sm-6 push-10">
                                            <div class="input-group">
                                                <span class="input-group-addon" onclick="$('#DataFineValutazione').datetimepicker('show')"><i class="fa fa-calendar"></i></span>
                                                @Html.TextBoxFor(m => m.DataFineValutazione, new { @class = "js-datetimepicker  form-control", data_format = "DD/MM/YYYY", data_locale = "it", placeholder = "Inizio assegnazione", autocomplete = "off", required = "required" })
                                            </div>
                                            @Html.ValidationMessageFor(m => m.DataFineValutazione)
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                        @*<div class="tab-pane" id="tab-importi" role="tabpanel">*@
                        <div class="hidden" id="tab-importi" role="tabpanel">
                            @using (Html.BeginBlock(BlockType.ContentTable, "Importi nominali"))
                            {
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-sm-12 push-10">
                                            @Html.LabelForRequiredObbl(m => m.ImportoTop, "Dirigenti Top", new { @class = "rai-caption" })
                                            @Html.TextBoxFor(m => m.ImportoTop, new { @class = "form-control", required = "required", data_type = "currency", pattern = @"^\d{1,3}(.\d{3})*(\,\d+)?$", placeholder = "0,00", data_orig = Model.ImportoTop, onchange = "MboCheckImport()" })
                                            @Html.ValidationMessageFor(m => m.ImportoTop)
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-12 push-10">
                                            @Html.LabelForRequiredObbl(m => m.ImportoFull, "Dirigenti Full", new { @class = "rai-caption" })
                                            @Html.TextBoxFor(m => m.ImportoFull, new { @class = "form-control", required = "required", data_type = "currency", pattern = @"^\d{1,3}(.\d{3})*(\,\d+)?$", placeholder = "0,00", data_orig = Model.ImportoFull, onchange = "MboCheckImport()" })
                                            @Html.ValidationMessageFor(m => m.ImportoFull)
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-12 push-10">
                                            @Html.LabelForRequiredObbl(m => m.ImportoManager, "Dirigenti Manager", new { @class = "rai-caption" })
                                            @Html.TextBoxFor(m => m.ImportoManager, new { @class = "form-control", required = "required", data_type = "currency", pattern = @"^\d{1,3}(.\d{3})*(\,\d+)?$", placeholder = "0,00", data_orig = Model.ImportoManager, onchange = "MboCheckImport()" })
                                            @Html.ValidationMessageFor(m => m.ImportoManager)
                                        </div>
                                    </div>
                                    <div class="row hidden" id="lblReloadSch">
                                        <div class="col-sm-12 push-10">
                                            <label><i>La modifica degli importi comporta l'aggiornamento degli importi teorici solo per le schede generate dal sistema e non modificate.</i></label>
                                            <div class="rai-checkbox">
                                                <input id="reloadMan" name="reloadMan" value="true" />
                                                <label for="reloadMan">Forza aggiornamento importi per tutte le schede</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                        <div class="tab-pane" id="tab-schede" role="tabpanel">
                            <div class="rai-op-nav" id="schede-nav">
                                <div class="row">
                                    <div class="col-xs-12">
                                        <div class="rai-op-breadcrumb" style="display:none">
                                            <span data-op-path="main" onclick="MboGotoMainNav()">Elenco schede</span>
                                            <span class="fa fa-chevron-right" data-op-path="sub" data-target="schede-dett" data-op-arrow=""></span><span data-op-path="sub" data-target="schede-dett" onclick="RaiOPGotoThisPage('schede-nav', 'schede-dett', false)">Dettaglio</span>
                                            <span class="fa fa-chevron-right" data-op-path="sub" data-target="schede-nuovo" data-op-arrow=""></span><span data-op-path="sub" data-target="schede-nuovo" onclick="RaiOPGotoThisPage('schede-nav', 'schede-nuovo', false)">Nuova scheda</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="rai-op-main">
                                    <div class="block block-content-table">
                                        <div class="block-header">
                                            <label class="block-title">Elenco schede</label>
                                            <div class="block-options">
                                                <button class="btn rai-btn-small" onclick="MboAggiungiScheda()">Aggiungi scheda</button>
                                            </div>
                                        </div>
                                        <div class="block-content">
                                            <div id="ini-elenco-schede" data-loaded="false"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="rai-op-sub" style="display:none">
                                    <div class="rai-op-sub-page" id="schede-dett">
                                        @using (Html.BeginBlock(BlockType.ContentTable, "Dettaglio scheda"))
                                        {
                                            <div class="form-group">
                                                <input type="hidden" id="sch-idpers" />
                                                <input type="hidden" id="sch-hasOper" />
                                                <input type="hidden" id="sch-extra" />
                                                <input type="hidden" id="sch-nome" />
                                                <input type="hidden" id="sch-servizio" />
                                                <div class="row">
                                                    <div class="col-sm-12 push-10">
                                                        <label class="rai-caption">Nominativo</label>
                                                        <div id="sch-nominativo"></div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-sm-12 push-10">
                                                        <label class="rai-caption">Responsabile</label>
                                                        @Html.RaiSelect("sch-resp-sel", new List<SelectListItem>())
                                                        <div id="sch-resp"></div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-sm-12 push-10">
                                                        <label class="rai-caption">Importo</label>
                                                        <input type="text" class="form-control" id="sch-importo" data-type="currency" pattern="^\d{1,3}(.\d{3})*(\,\d+)?$" placeholder="0,00" />
                                                    </div>
                                                </div>
                                                <div class="row form-button">
                                                    <div class="col-sm-12 text-right">
                                                        <div class="">
                                                            <a onclick="event.preventDefault(); MboGotoMainNav();" style="margin-right:10px;">Indietro</a>
                                                            <button class="btn rai-btn-small" onclick="MboApplicaImportoScheda()" >Salva</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                    <div class="rai-op-sub-page" id="schede-nuovo">
                                        <form id="form-ricerca-nuovo" method="post" action="#">
                                            <div class="form-group form-group-sm">
                                                <div class="row">
                                                    <div class="col-sm-6">
                                                        <label for="ric-matricola" class="rai-caption">Matricola</label>
                                                        <input type="text" name="ric-matricola" id="ric-matricola" class="form-control" />
                                                    </div>
                                                    <div class="col-sm-6">
                                                        <label for="ric-nominativo" class="rai-caption">Nominativo</label>
                                                        <input type="text" name="ric-nominativo" id="ric-nominativo" class="form-control" />
                                                    </div>
                                                </div>
                                                <div class="row form-button">
                                                    <div class="col-sm-12 text-right">
                                                        <a onclick="event.preventDefault(); MboRicercaPulisci();">
                                                            Azzera filtri
                                                        </a>
                                                        <input type="submit" class="btn rai-btn-small push-10-l " onclick="MboRicercaCerca()" value="Cerca" />
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                        <div id="ric-elenco-ext">
                                            <div id="ric-elenco">

                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane" id="tab-riepilogo" role="tabpanel">
                            @using (Html.BeginBlock(BlockType.ContentTable, "Parametri generali"))
                            {
                                <div class="rai-table-info">
                                    <div class="row">
                                        <div class="col-sm-6 col-md-5 col-lg-3">
                                            <span>Nome</span>
                                        </div>
                                        <div class="col-sm-6 col-md-7 col-lg-9">
                                            <span id="lblNome"></span>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-6 col-md-5 col-lg-3">
                                            <span>Descrizione</span>
                                        </div>
                                        <div class="col-sm-6 col-md-7 col-lg-9">
                                            <span id="lblDes"></span>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-6 col-md-5 col-lg-3">
                                            <span>Periodo assegnazione</span>
                                        </div>
                                        <div class="col-sm-6 col-md-7 col-lg-9">
                                            <span id="lblAss"></span>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-6 col-md-5 col-lg-3">
                                            <span>Periodo valutazione</span>
                                        </div>
                                        <div class="col-sm-6 col-md-7 col-lg-9">
                                            <span id="lblVal"></span>
                                        </div>
                                    </div>
                                </div>
                            }

                            @using (Html.BeginBlock(BlockType.ContentTable, "Importi nominali"))
                            {
                                <div class="row">
                                    <div class="col-sm-12">
                                        <table class="table rai-table rai-table-vcenter rai-table-high-row" id="tblRiepilogo">
                                            <thead>
                                                <tr>
                                                    @*<th>Tipologia dirigente</th>*@
                                                    <th>Importo nominale</th>
                                                    <th class="text-right">N. risorse</th>
                                                    <th class="text-right">Importo totale</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @*<tr>
                                                        <td><span>Top</span></td>
                                                        <td class="text-right"><span id="lblTop"></span></td>
                                                        <td class="text-right"><span id="numTop"></span></td>
                                                        <td class="text-right"><span id="totTop"></span></td>
                                                    </tr>
                                                    <tr>
                                                        <td><span>Full</span></td>
                                                        <td class="text-right"><span id="lblFull"></span></td>
                                                        <td class="text-right"><span id="numFull"></span></td>
                                                        <td class="text-right"><span id="totFull"></span></td>
                                                    </tr>
                                                    <tr>
                                                        <td><span>Manager</span></td>
                                                        <td class="text-right"><span id="lblManager"></span></td>
                                                        <td class="text-right"><span id="numManager"></span></td>
                                                        <td class="text-right"><span id="totManager"></span></td>
                                                    </tr>*@
                                            </tbody>
                                            <tfoot>
                                                <tr>
                                                    <td @*class="text-right"*@><span>Totale</span></td>
                                                    <td class="text-right"><span class="text-bold text-right" id="numBdg"></span></td>
                                                    <td class="text-right"><span class="text-bold text-right" id="totBdg"></span></td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <div class="row push-20-t" id="btnWizard">
                    <div class="col-sm-12">
                        <div class="rai-btn-fill">
                            <button class="btn rai-btn-secondary hidden" onclick="GotoPrevious()" id="btnPrev">Indietro</button>
                            <button class="btn rai-btn-primary" onclick="GotoNext()" id="btnNext">Prosegui</button>
                            <button class="btn rai-btn-primary hidden" type="submit" onclick="MboSaveIniziativa()" id="btnSave">Salva</button>
                        </div>
                    </div>
                </div>
            }
        }
    }
}

<script>
    InitDatePicker();
    function InitDRPicker() {
        InitDateRangePicker();
        //$('#rangeValutazione').data('daterangepicker').minDate = $('#rangeAssegnazione').data('daterangepicker').startDate;
    }
    InitDRPicker();
    $('#rangeAssegnazione').on({
        'apply.daterangepicker': function (event, daterange) {
            setDateRange(daterange, 'Assegnazione');
            //$('#rangeValutazione').data('daterangepicker').minDate = daterange.startDate;
        }
    })
    $('#rangeValutazione').on({
        'apply.daterangepicker': function (event, daterange) {
            setDateRange(daterange, 'Valutazione');
        }
    })

    $("input[data-type='currency']").on({
        keyup: function () {
            formatCurrency($(this));
        },
        blur: function () {
            formatCurrency($(this), "blur");
        },
    });

    function MboRicercaPulisci() {
        $('#ric-elenco').html('');
    }
    function MboRicercaCerca() {
        event.preventDefault();
        //$('#ric-elenco-ext').addClass('rai-loader');
        var matricola = $('#ric-matricola').val();
        var nominativo = $('#ric-nominativo').val();
        RaiUpdateWidget('ric-elenco', '/Mbo/Ricerca', 'html', { matricola: matricola, nominativo: nominativo });
    }
    function MboRicercaCrea(button) {
        event.preventDefault();
        var tr = $(button).parent().parent();
        var idPers = $(tr).attr('data-iddipendente');

        if ($('tr[data-id-pers="' + idPers + '"]').length > 0) {
            swal('Attenzione', 'La scheda è già presente', 'warning');
            return;
        }

        $('#sch-idpers').val(idPers);

        $('#sch-nominativo').html($(tr).find('td').eq(0).html());

        $('#sch-nome').val($(tr).attr('data-nominativo'));
        $('#sch-servizio').val($(tr).attr('data-servizio'));

        $('#sch-importo').val(0);
        $('#sch-extra').val(1);

        RaiOPGotoThisPage('schede-nav', 'schede-dett', false);

        $('#sch-resp-sel').parent().addClass('rai-loader');
        var c = $('#sch-resp-sel').parent().attr('id');
        RaiSelectExtLoadAsyncData('sch-resp-sel', '/Mbo/GetIncarichiResponsabili', { idPers: -1 }, true, function () {
            //var idResp = $(tr).attr('data-id-resp');
            //RaiSelectOption(idResp, c, false);
            $('#sch-resp-sel').parent().removeClass('rai-loader');
        });
        $('#sch-hasOper').val(0);
        formatAllInput();
    }

    function formatAllInput() {
        var list = $("input[data-type='currency']");
        for (var i = 0; i < list.length; i++) {
            formatCurrency($(list[i]));
        }
    }

    function setDateRange(daterange, nameDate) {
        $('#DataInizio' + nameDate).val(daterange.startDate.format("DD/MM/YYYY"));
        $('#DataFine' + nameDate).val(daterange.endDate.format("DD/MM/YYYY"));
    }


    function GotoPrevious() {
        event.preventDefault();

        var active = $('#ini-wizard li.tabhead.active');
        var list = $('#ini-wizard li.tabhead');
        var listTab = $('#ini-wizard div.tab-pane');
        var current = $(list).index(active);

        $(list[current]).removeClass('active');
        $(listTab[current]).removeClass('active');

        $(list[current - 1]).removeClass('completed').addClass('active');
        $(listTab[current - 1]).addClass('active');


        if (current == 1) {
            $('#btnPrev').addClass('hidden');
        } else if (current == list.length - 1) {
            $('#btnNext').removeClass('hidden');
            $('#btnSave').addClass('hidden');
        }
    }
    function GotoNext() {
        event.preventDefault();

        var validator = $("#form-iniziativa").validate();
        if (!$("#form-iniziativa").valid()) {
            validator.focusInvalid();
            return false;
        }

        var active = $('#ini-wizard li.tabhead.active');
        var list = $('#ini-wizard li.tabhead');
        var listTab = $('#ini-wizard div.tab-pane');
        var current = $(list).index(active);

        //Se si conferma il tab degli importi
        //Bisogna caricare l'elenco delle schede
        if (current == 0) {
            //if ($('#rangeValutazione').data('daterangepicker').startDate < $('#rangeAssegnazione').data('daterangepicker').startDate) {
            //    swal("Attenzione", "L'inizio del periodo di valutazione deve essere successivo all'inizio del periodo di assegnazione.");
            //    return;
            //}

            setDateRange($('#rangeAssegnazione').data('daterangepicker'), 'Assegnazione');
            setDateRange($('#rangeValutazione').data('daterangepicker'), 'Valutazione');

            formatAllInput();
            //}
            //else if (current == 1) {
            var idIni = $('#Id').val();
            var impTop = formatForAjax($('#ImportoTop').val());
            var impFull = formatForAjax($('#ImportoFull').val());
            var impManager = formatForAjax($('#ImportoManager').val());
            var forceReload = $('#reloadMan').val();

            var isLoaded = $('#ini-elenco-schede').attr('data-loaded');
            if (isLoaded == 'false') {
                RaiUpdateWidget("ini-elenco-schede", "/Mbo/Get_Elenco_Schede", "html", { idIni: idIni, importoTop: impTop, importoFull: impFull, importoManager: impManager });
                $('#ini-elenco-schede').attr('data-loaded', 'true');
            }
        }
        //else if (current == 2) {
        else if (current == 1) {
            $('#lblNome').text($('#Nome').val());
            $('#lblDes').text($('#Descrizione').val());
            $('#lblAss').text('Dal ' + $('#DataInizioAssegnazione').val() + ' al ' + $('#DataFineAssegnazione').val());
            $('#lblVal').text('Dal ' + $('#DataInizioValutazione').val() + ' al ' + $('#DataFineValutazione').val());

            var totBdg = 0;
            var listEl = $('[data-scheda-master]');
            var listImp = new Array();

            var totRow = 0;

            for (var i = 0; i < listEl.length; i++) {
                var isDel = $(listEl[i]).attr('data-deleteOper');
                if (isDel == 'true')
                    continue;

                totRow += 1;

                var importoRef = parseFloat($(listEl[i]).attr('data-imp'));

                var el = listImp.find(x => x.Importo == importoRef);
                if (el != null) {
                    el.Counter++;
                    el.Tot += parseFloat(importoRef);
                } else {
                    listImp.push({
                        Importo: importoRef,
                        Counter: 1,
                        Tot: parseFloat(importoRef)
                    });
                }

                totBdg += parseFloat(importoRef);
            }


            listImp.sort(function (a, b) {
                if (a.Importo < b.Importo)
                    return -1;
                else if (a.Importo > b.Importo)
                    return 1;
                else
                    return 0;
            });


            $('#tblRiepilogo > tbody').html('');
            for (var i = 0; i < listImp.length; i++) {
                $('#tblRiepilogo > tbody').append('<tr><td>' + formatNumber('' + listImp[i].Importo + '') + ' €</td><td class="text-right">' + listImp[i].Counter + '</td><td class="text-right">' + formatNumber('' + listImp[i].Tot + '') + ' €</td></tr>');
            }

            $('#numBdg').text(totRow);
            $('#totBdg').text(formatNumber('' + totBdg + '') + " €");
        }

        $(list[current]).removeClass('active').addClass('completed');
        $(listTab[current]).removeClass('active');

        $(list[current + 1]).addClass('active');
        $(listTab[current + 1]).addClass('active');

        if (current == 0) {
            $('#btnPrev').removeClass('hidden');
        } else if (current == list.length - 2) {
            $('#btnNext').addClass('hidden');
            $('#btnSave').removeClass('hidden');
        }
    }
    function MboSaveIniziativa() {
        event.preventDefault();

        $('#btnWizard').addClass('rai-loader');
        $('#btnWizard .btn').enable = false;

        var formData = new FormData($('#form-iniziativa')[0]);
        formData.set("ImportoTop", $('#ImportoTop').val());
        formData.set("ImportoFull", $('#ImportoFull').val());
        formData.set("ImportoManager", $('#ImportoManager').val());

        var listSchede = $('[data-scheda-master][data-manchanged="1"]');

        var schede = new Array();
        for (var i = 0; i < listSchede.length; i++) {
            schede.push({
                Id: $(listSchede[i]).attr('data-scheda-master'),
                IdPersonaValutato: $(listSchede[i]).attr('data-id-pers'),
                IdPersonaResp: $(listSchede[i]).attr('data-id-resp'),
                ImportoTeorico: $(listSchede[i]).attr('data-imp'),
                DeleteOper: $(listSchede[i]).attr('data-deleteOper'),
                ManChanged: true,
                IsExtra: $(listSchede[i]).attr('data-isExtra')
            });
        }

        var entr = Array.from(formData.entries()).reduce((memo, pair) => ({
            ...memo,
            [pair[0]]: pair[1],
        }), {});

        $.ajax({
            url: "/Mbo/Save_Iniziativa",
            type: "POST",
            cache: false,
            dataType: 'html',
            //contentType: false,
            //processData: false,
            contentType: 'application/json',
            data: JSON.stringify({ iniziativa: entr, mSchede: schede }),
            success: function (data) {
                switch (data) {
                    case "OK":
                        swal("Iniziativa creata", "L'iniziativa è stata salvata correttamente", 'success');
                        MboUpdateIniziative();
                        $('#modal-mbo-half').modal('hide');
                        $('#form-mbo-ricerca').submit();
                        RaiUpdateWidget('wdgt-ricerca', '/Mbo/Widget_ricerca', 'html');
                        break;
                    default:
                        swal("Oops...", data, 'error');
                        $('#btnWizard').removeClass('rai-loader');
                        $('#btnWizard .btn').enable = true;
                }
            },
            error: function (a, b, c) {
                swal('Oops...', c, 'error');
            }
        });
    }

    function MboModificaImportoScheda(button) {
        event.preventDefault();

        var tr = $(button).closest('tr');

        $('#sch-idpers').val($(tr).attr('data-id-pers'));
        $('#sch-nominativo').html($(tr).find('td').eq(0).html());

        $('#sch-importo').val($(tr).attr('data-imp'));
        $('#sch-extra').val(0);

        RaiOPGotoThisPage('schede-nav', 'schede-dett', false);

        $('#sch-resp-sel').parent().addClass('rai-loader');
        var c = $('#sch-resp-sel').parent().attr('id');
        RaiSelectExtLoadAsyncData('sch-resp-sel', '/Mbo/GetIncarichiResponsabili', { idPers: $(tr).attr('data-id-pers') }, true, function () {
            var idResp = $(tr).attr('data-id-resp');
            RaiSelectOption(idResp, c, false);
            $('#sch-resp-sel').parent().removeClass('rai-loader');
        });
        $('#sch-hasOper').val($(tr).attr('data-hasOper'));
        formatAllInput();

        $('#btnWizard').hide();
    }

    function MboAggiungiScheda() {
        event.preventDefault();

        RaiOPGotoThisPage('schede-nav', 'schede-nuovo', false);
        //$('#form-ricerca-nuovo')[0].clear();

        $('#btnWizard').hide();
    }

    function MboApplicaImportoScheda() {
        event.preventDefault();

        var schHasOper = $('#sch-hasOper').val();
        if (schHasOper == 'true') {
            swal({
                title: 'Attenzione',
                text: "E' necessario assegnare nuovi obiettivi?",
                type: 'question',
                customClass: 'rai',
                showCancelButton: true,
                confirmButtonText: 'Conferma',
                cancelButtonText: 'Annulla',
                reverseButtons: true
            }).then(function () {
                MboSaveObPerc(true);
                return;
            });
            MboSaveObPerc(false);

        } else {
            InternalMboApplicaImportoScheda(false);
        }
    }
    function InternalMboApplicaImportoScheda(deleteOper) {
        var isExtra = $('#sch-extra').val();

        if (isExtra == 1) {
            var newTr = '<tr data-scheda-master="0" data-id-pers="' + $('#sch-idpers').val() + '" data-isExtra="true" data-search="elenco-master" data-search-nome="' + $('#sch-nome').val() + '" data-search-dir="' + $('#sch-servizio').val() + '">';
            newTr += '<td>' + $('#sch-nominativo').html() + '</td>';
            newTr += '<td></td>';
            newTr += '<td class="text-right"><span></span></td>';
            newTr += '<td class="text-right"><button class="btn rai-btn-small" onclick="MboModificaImportoScheda(this)">Modifica</button>';
            newTr += '</tr>';
            $($('tr[data-scheda-master]')[0]).before(newTr);
        }
        var tr = $('tr[data-id-pers="' + $('#sch-idpers').val() + '"]');

        //Responsabile
        var resp = $('#sch-resp-sel').val();
        $(tr).attr('data-id-resp', resp);
        if (resp != undefined && resp!='undefined' && resp != '') {
            $(tr).find('td').eq(1).html("<span>" + $('#sch-resp-sel').text() + "</span>");
            var countWO = parseInt($('#persWOResp').attr('data-count')) - 1;
            $('#persWOResp').attr('data-count', countWO);
            if (countWO == 0)
                $('#persWOResp').hide();
        } else {
            $(tr).find('td').eq(1).html('<span class="rai-label rai-label-warning">Non assegnato</span>');
            var countWO = parseInt($('#persWOResp').attr('data-count')) + 1;
            $('#persWOResp').attr('data-count', countWO);
            $('#persWOResp').show();
        }

        $(tr).attr('data-deleteOper', deleteOper);

        //importo
        $(tr).attr('data-imp', $('#sch-importo').val().replace('.', ''));
        $(tr).find('td').eq(2).html("<span>" + $('#sch-importo').val() + " €</span>");

        $(tr).attr('data-manchanged', '1');

        SearchInit();

        MboGotoMainNav();
    }

    function MboGotoMainNav() {
        RaiOPGotoMain('schede-nav', false);
        $('#btnWizard').show();
    }

    function MboCheckImport() {
        var topOrig = $('#ImportoTop').attr('data-orig').replace(".", '');
        var topNew = $('#ImportoTop').val().replace('.', '');

        var fullOrig = $('#ImportoFull').attr('data-orig').replace(".", '');
        var fullNew = $('#ImportoFull').val().replace('.', '');

        var managerOrig = $('#ImportoManager').attr('data-orig').replace(".", '');
        var managerNew = $('#ImportoManager').val().replace('.', '');

        if ($('#Id').val() != 0) {
            if (topOrig != topNew || fullOrig != fullNew || managerOrig != managerNew) {
                $('#lblReloadSch.hidden').removeClass('hidden');
            }
            else {
                $('#lblReloadSch:not(.hidden)').addClass('hidden');
            }
        }
    }

    function MboEliminaScheda(button) {
        event.preventDefault();

        var profile = $(button).closest('tr').find('.rai-profile-widget');
        
        swal({
            title: 'Sei sicuro?',
            html: 'Vuoi eliminare questa scheda?<br/>' + $(profile).html(),
            type: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Conferma',
            cancelButtonText: 'Annulla',
            reverseButtons: true
        }).then(function () {
            var tr = $(button).closest('tr');
            $(tr).attr('data-deleteOper', 'true');
            $(tr).attr('data-manchanged', '1');
            $(tr).attr('data-search', '');
            $(tr).find('td:last').html('');
            $(tr).hide();
            SearchOnChange();
        });
    }
</script>